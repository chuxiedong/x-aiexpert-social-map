<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>迭代进度</title>
  <script src="./assets/metrics.js" defer></script>
  <style>
    :root{--bg:#0a1022;--card:#121b36;--line:rgba(255,255,255,.14);--text:#edf3ff;--muted:#95a9d5;--ok:#49d6a6;--bad:#f87171}
    *{box-sizing:border-box} body{margin:0;background:radial-gradient(circle at 10% 0%, #19356d 0%, var(--bg) 44%);color:var(--text);font-family:"IBM Plex Sans","PingFang SC","Microsoft YaHei",sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}.top{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(125,177,255,.45);background:linear-gradient(135deg,#1d3f82,#143062);color:#eef4ff;text-decoration:none;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .k{color:var(--muted);font-size:12px}.v{font-size:24px;font-weight:800;margin-top:6px}
    .timeline{margin-top:10px}.item{border:1px solid var(--line);border-radius:10px;padding:10px;background:#101a32;margin-bottom:8px}
    .ok{color:var(--ok);font-weight:700}.bad{color:var(--bad);font-weight:700}.muted{color:var(--muted);font-size:12px}
    @media(max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2>迭代进度 / Iteration Timeline</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="./index.html">首页</a>
      <a class="btn" href="./ops.html">Ops</a>
      <a class="btn" href="./commercial.html">商业方案</a>
    </div>
  </div>

  <div class="grid">
    <div class="card"><div class="k">最近状态</div><div class="v" id="kStatus">-</div></div>
    <div class="card"><div class="k">最近心跳</div><div class="v" id="kBeat" style="font-size:16px">-</div></div>
    <div class="card"><div class="k">累计迭代条数</div><div class="v" id="kRuns">-</div></div>
    <div class="card"><div class="k">平均时长(ms)</div><div class="v" id="kDur">-</div></div>
  </div>

  <div class="card timeline">
    <h3 style="margin-top:0">迭代时间线（最近50次）</h3>
    <div id="timeline"></div>
  </div>
</div>
<script>
async function boot(){
  const beat=await fetch('./data/heartbeat_status.json').then(r=>r.json()).catch(()=>null);
  const log=await fetch('./data/iteration_log.json').then(r=>r.json()).catch(()=>[]);
  const rows=Array.isArray(log)?log:[];
  const avg=rows.length?Math.round(rows.reduce((s,x)=>s+Number(x.duration_ms||0),0)/rows.length):0;
  document.getElementById('kRuns').textContent=rows.length;
  document.getElementById('kDur').textContent=avg;
  document.getElementById('kStatus').innerHTML=beat && beat.status==='ok' ? '<span class="ok">OK</span>' : '<span class="bad">DEGRADED</span>';
  document.getElementById('kBeat').textContent=beat && beat.generated_at ? beat.generated_at.replace('T',' ').slice(0,19) : '-';

  document.getElementById('timeline').innerHTML=rows.slice(-50).reverse().map((x,i)=>{
    const ok=x.status==='ok';
    return `<div class="item"><div><b>#${rows.length-i}</b> ${ok?'<span class="ok">OK</span>':'<span class="bad">DEGRADED</span>'} <span class="muted">${(x.ts||'').replace('T',' ').slice(0,19)}</span></div><div class="muted">build=${x.build_result} · checks=${x.checks_count} · missing=${x.missing_count} · duration=${x.duration_ms}ms</div><div class="muted">${x.note||''}</div></div>`;
  }).join('') || '<div class="muted">暂无迭代记录，等待心跳写入。</div>';
}
boot();
</script>
</body>
</html>
